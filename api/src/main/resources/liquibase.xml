<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <changeSet id="messages-1" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="messages_scheduled_service_group"/></not>
        </preConditions>
        <comment>Created the messages_scheduled_service_group table</comment>
        <createTable tableName="messages_scheduled_service_group">
            <column name="messages_scheduled_service_group_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="msg_send_time" type="datetime"/>
            <column name="patient_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(255)"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_group_creator_fk"
                                 baseTableName="messages_scheduled_service_group" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_group_changed_by_fk"
                                 baseTableName="messages_scheduled_service_group" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_group_voided_by_fk"
                                 baseTableName="messages_scheduled_service_group" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_group_patient_fk"
                                 baseTableName="messages_scheduled_service_group" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
    </changeSet>

    <changeSet id="messages-2" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="messages_template"/></not>
        </preConditions>
        <comment>Created the messages_template table</comment>
        <createTable tableName="messages_template">
            <column name="messages_template_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="service_query" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="service_query_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_template_creator_fk"
                                 baseTableName="messages_template" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_changed_by_fk"
                                 baseTableName="messages_template" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_voided_by_fk"
                                 baseTableName="messages_template" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        </changeSet>

    <changeSet id="messages-3" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="messages_template_field"/></not>
        </preConditions>
        <comment>Created the messages_template_field table</comment>
        <createTable tableName="messages_template_field">
            <column name="messages_template_field_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mandatory" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="default_value" type="TEXT"/>
            <column name="template_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="value_concept" type="int"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_template_field_creator_fk"
                                 baseTableName="messages_template_field" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_changed_by_fk"
                                 baseTableName="messages_template_field" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_voided_by_fk"
                                 baseTableName="messages_template_field" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_template_fk"
                                 baseTableName="messages_template_field" baseColumnNames="template_id"
                                 referencedTableName="messages_template" referencedColumnNames="messages_template_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_value_concept_fk"
                                 baseTableName="messages_template_field" baseColumnNames="value_concept"
                                 referencedTableName="concept" referencedColumnNames="concept_id"/>
    </changeSet>

    <changeSet id="messages-4" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="messages_template_field_value"/></not>
        </preConditions>
        <comment>Created the messages_template_field_value table</comment>
        <createTable tableName="messages_template_field_value">
            <column name="messages_template_field_value_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="value" type="varchar(255)"/>
            <column name="template_field_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="patient_template_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_template_field_value_creator_fk"
                                 baseTableName="messages_template_field_value" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_value_changed_by_fk"
                                 baseTableName="messages_template_field_value" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_value_voided_by_fk"
                                 baseTableName="messages_template_field_value" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_value_template_field_fk"
                                 baseTableName="messages_template_field_value" baseColumnNames="template_field_id"
                                 referencedTableName="messages_template_field"
                                 referencedColumnNames="messages_template_field_id"/>
        </changeSet>

    <changeSet id="messages-5" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="messages_patient_template"/></not>
        </preConditions>
        <comment>Created the messages_patient_template table</comment>
        <createTable tableName="messages_patient_template">
            <column name="messages_patient_template_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="actor_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="actor_type" type="int"/>
            <column name="service_query" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="service_query_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="patient_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="template_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_patient_template_creator_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_patient_template_changed_by_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_patient_template_voided_by_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_patient_template_actor_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="actor_id"
                                 referencedTableName="person" referencedColumnNames="person_id"/>
        <addForeignKeyConstraint constraintName="messages_patient_template_actor_type_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="actor_type"
                                 referencedTableName="relationship" referencedColumnNames="relationship_id"/>
        <addForeignKeyConstraint constraintName="messages_patient_template_patient_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
        <addForeignKeyConstraint constraintName="messages_patient_template_template_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="template_id"
                                 referencedTableName="messages_template_field_value"
                                 referencedColumnNames="messages_template_field_value_id"/>
    </changeSet>

    <changeSet id="messages-6" author="Dawid Ruchniewicz">
        <preConditions>
            <not><tableExists tableName="messages_scheduled_service"/></not>
        </preConditions>
        <comment>Created the messages_scheduled_service table</comment>
        <createTable tableName="messages_scheduled_service">
            <column name="messages_scheduled_service_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="group_id" type="int"/>
            <column name="service" type="int"/>
            <column name="patient_template_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="channel_type" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(255)"/>
            <column name="last_service_execution_id" type="int"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_creator_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_changed_by_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_voided_by_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_group_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="group_id"
                                 referencedTableName="messages_scheduled_service_group"
                                 referencedColumnNames="messages_scheduled_service_group_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_service_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="service"
                                 referencedTableName="concept" referencedColumnNames="concept_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_patient_template_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="patient_template_id"
                                 referencedTableName="messages_patient_template"
                                 referencedColumnNames="messages_patient_template_id"/>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_channel_type_fk"
                                 baseTableName="messages_scheduled_service" baseColumnNames="channel_type"
                                 referencedTableName="concept" referencedColumnNames="concept_id"/>
    </changeSet>

    <changeSet id="messages-7" author="Dawid Ruchniewicz">
        <preConditions>
            <not><tableExists tableName="messages_actor_response"/></not>
        </preConditions>
        <comment>Created the messages_actor_response table</comment>
        <createTable tableName="messages_actor_response">
            <column name="messages_actor_response_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="scheduled_service_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="question" type="int"/>
            <column name="response" type="int"/>
            <column name="text_response" type="TEXT"/>
            <column name="answered_time" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_actor_response_creator_fk"
                                 baseTableName="messages_actor_response" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_actor_response_changed_by_fk"
                                 baseTableName="messages_actor_response" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_actor_response_voided_by_fk"
                                 baseTableName="messages_actor_response" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_actor_response_scheduled_service_fk"
                                 baseTableName="messages_actor_response" baseColumnNames="scheduled_service_id"
                                 referencedTableName="messages_scheduled_service"
                                 referencedColumnNames="messages_scheduled_service_id"/>
        <addForeignKeyConstraint constraintName="messages_actor_response_question_fk"
                                 baseTableName="messages_actor_response" baseColumnNames="question"
                                 referencedTableName="concept" referencedColumnNames="concept_id"/>
        <addForeignKeyConstraint constraintName="messages_actor_response_response_fk"
                                 baseTableName="messages_actor_response" baseColumnNames="response"
                                 referencedTableName="concept" referencedColumnNames="concept_id"/>
    </changeSet>

    <changeSet id="messages-8" author="Dawid Ruchniewicz">
        <preConditions>
            <not><tableExists tableName="messages_delivery_attempt"/></not>
        </preConditions>
        <comment>Created the messages_delivery_attempt table</comment>
        <createTable tableName="messages_delivery_attempt">
            <column name="messages_delivery_attempt_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="scheduled_service_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="new_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="attempt_number" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="service_execution_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_delivery_attempt_creator_fk"
                                 baseTableName="messages_delivery_attempt" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_delivery_attempt_changed_by_fk"
                                 baseTableName="messages_delivery_attempt" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_delivery_attempt_voided_by_fk"
                                 baseTableName="messages_delivery_attempt" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_delivery_attempt_service_fk"
                                 baseTableName="messages_delivery_attempt" baseColumnNames="scheduled_service_id"
                                 referencedTableName="concept" referencedColumnNames="concept_id"/>
    </changeSet>

    <changeSet id="messages-9" author="Dawid Ruchniewicz">
        <preConditions>
            <not><tableExists tableName="messages_schedule_service_parameter"/></not>
        </preConditions>
        <comment>Created the messages_schedule_service_parameter table</comment>
        <createTable tableName="messages_schedule_service_parameter">
            <column name="messages_schedule_service_parameter_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="scheduled_message" type="int"/>
            <column name="parameter_type" type="varchar(255)"/>
            <column name="parameter_value" type="TEXT"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_schedule_service_parameter_creator_fk"
                                 baseTableName="messages_schedule_service_parameter" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_schedule_service_parameter_changed_by_fk"
                                 baseTableName="messages_schedule_service_parameter" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_schedule_service_parameter_voided_by_fk"
                                 baseTableName="messages_schedule_service_parameter" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="messages_schedule_service_parameter_scheduled_message_fk"
                                 baseTableName="messages_schedule_service_parameter" baseColumnNames="scheduled_message"
                                 referencedTableName="messages_scheduled_service"
                                 referencedColumnNames="messages_scheduled_service_id"/>
    </changeSet>

    <changeSet id="messages-10" author="Paweł Cieszko">
        <addUniqueConstraint columnNames="actor_id, patient_id, template_id"
                             constraintName="messages_patient_template_actor_id_patient_id_template_id_ux"
                             tableName="messages_patient_template"/>
    </changeSet>

    <changeSet id="messages-11" author="Dawid Ruchniewcz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_template_field_value"/>
            <columnExists tableName="messages_template_field_value" columnName="patient_template_id"/>
        </preConditions>
        <comment>Removed patient_template_id column</comment>
        <dropColumn tableName="messages_template_field_value"
                    columnName="patient_template_id"/>
    </changeSet>

    <changeSet id="messages-12" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_scheduled_service"/>
            <columnExists tableName="messages_scheduled_service" columnName="last_service_execution_id"/>
        </preConditions>
        <comment>Removed lastServiceExecution column</comment>
        <dropColumn tableName="messages_scheduled_service"
                    columnName="last_service_execution_id"/>
    </changeSet>

    <changeSet id="messages-13" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_scheduled_service"/>
        </preConditions>
        <comment>Added lastServiceExecution column</comment>
        <addColumn tableName="messages_scheduled_service">
            <column name="last_service_execution_id" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="messages-14" author="Daniel Serkowski">
        <preConditions>
            <tableExists tableName="messages_delivery_attempt"/>
        </preConditions>
        <dropForeignKeyConstraint constraintName="messages_delivery_attempt_service_fk" 
                                  baseTableName="messages_delivery_attempt" />
        <addForeignKeyConstraint constraintName="messages_delivery_attempt_scheduled_service_fk"
                                 baseTableName="messages_delivery_attempt" baseColumnNames="scheduled_service_id"
                                 referencedTableName="messages_scheduled_service"
                                 referencedColumnNames="messages_scheduled_service_id" />
    </changeSet>

    <changeSet id="messages-15" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_template_field"/>
        </preConditions>
        <comment>Added templateFieldType column</comment>
        <addColumn tableName="messages_template_field">
            <column name="template_field_type" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <dropForeignKeyConstraint constraintName="messages_template_field_value_concept_fk" baseTableName="messages_template_field"/>
        <dropColumn tableName="messages_template_field" columnName="value_concept"/>
    </changeSet>

    <changeSet id="messages-16" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_template"/>
        </preConditions>
        <comment>Added name column</comment>
        <addColumn tableName="messages_template">
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="messages-17" author="Karol Cissewski">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_template_field_value"/>
        </preConditions>
        <comment>Added patient_template_id column</comment>
        <addColumn tableName="messages_template_field_value">
            <column name="patient_template_id" type="int">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseTableName="messages_template_field_value" baseColumnNames="patient_template_id"
                                 constraintName="fk_messages_template_field_value_patient_template_id"
                                 referencedTableName="messages_patient_template"
                                 referencedColumnNames="messages_patient_template_id"/>
    </changeSet>

    <changeSet id="messages-18" author="Daniel Serkowski">
        <preConditions>
            <tableExists tableName="messages_patient_template" />
            <tableExists tableName="messages_template" />
        </preConditions>
        <comment>Fixing incorrect FK definition between PatientTemplate and Template tables</comment>
        <dropForeignKeyConstraint baseTableName="messages_patient_template"
                                  constraintName="messages_patient_template_template_fk" />
        <addForeignKeyConstraint constraintName="messages_patient_template_template_fk"
                                 baseTableName="messages_patient_template" baseColumnNames="template_id"
                                 referencedTableName="messages_template"
                                 referencedColumnNames="messages_template_id"/>
    </changeSet>

    <changeSet id="messages-19" author="Dawid Ruchniewicz">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_template_field"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM messages_template
                WHERE uuid = '9556482a-20b2-11ea-ac12-0242c0a82002'
            </sqlCheck>
        </preConditions>
        <comment>Added new inserts for templates and template fields</comment>
        <sql>
            INSERT INTO messages_template
            (service_query, service_query_type, name, creator, uuid, date_created)
            VALUES(
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, mssg_status as STATUS_ID from
            (select TIMESTAMP(selected_date, times) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS CHANNEL_ID
            from (select * from (select adddate(''2019-12-01'',t4*10000 + t3*1000 + t2*100 + t1*10 + t0) selected_date
            from  (select 0 t0 union select 1 union select 2 union select 3 union select 4 union  select 5 union
            select 6 union select 7 union select 8 union select 9) t0,  (select 0 t1 union select 1 union
            select 2 union select 3 union select 4 union  select 5 union select 6 union select 7 union
            select 8 union select 9) t1,  (select 0 t2 union select 1 union select 2 union select 3 union
            select 4 union  select 5 union select 6 union select 7 union select 8 union select 9) t2,
            (select 0 t3 union select 1 union select 2 union select 3 union select 4 union  select 5 union
            select 6 union select 7 union select 8 union select 9) t3,  (select 0 t4 union select 1 union
            select 2 union select 3 union select 4 union  select 5 union select 6 union select 7 union
            select 8 union select 9) t4) v where selected_date between :Start_of_daily_messages and :End_of_daily_messages
            and selected_date between :startDate and :endDate  and :Week_day_of_delivering_message
            like concat(''%'',DAYNAME(selected_date),''%'') ) dates JOIN (select :bestContactTime times) timeslist) temp
            LEFT JOIN (select mssg.msg_send_time as mssg_dates, mssg.status as mssg_status
            from messages_scheduled_service_group mssg where mssg.patient_id = :patientId) mss on mss.mssg_dates = EXECUTION_DATE;',
            'SQL',
            'Adherence report daily',
            1,
            '9556482a-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'Service type',
            1,
            'Deactivate service',
            (select messages_template_id from messages_template where uuid = '9556482a-20b2-11ea-ac12-0242c0a82002'),
            'SERVICE_TYPE',
            1,
            '95566224-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'Week day of delivering message',
            1,
            'Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday',
            (select messages_template_id from messages_template where uuid = '9556482a-20b2-11ea-ac12-0242c0a82002'),
            'DAY_OF_WEEK',
            1,
            '95567627-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'Start of daily messages',
            0,
            ' ',
            (select messages_template_id from messages_template where uuid = '9556482a-20b2-11ea-ac12-0242c0a82002'),
            'START_OF_MESSAGES',
            1,
            '955687fc-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'End of daily messages',
            1,
            '2020-01-30',
            (select messages_template_id from messages_template where uuid = '9556482a-20b2-11ea-ac12-0242c0a82002'),
            'END_OF_MESSAGES',
            1,
            '9556992c-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
    </changeSet>

    <changeSet id="messages-20" author="Daniel Serkowski">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="messages_scheduled_service_group"/>
        </preConditions>
        <comment>Adding missing actor_id column</comment>
        <addColumn tableName="messages_scheduled_service_group">
            <column name="actor_id" type="int">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="messages_scheduled_service_group_actor_fk"
                                 baseTableName="messages_scheduled_service_group" baseColumnNames="actor_id"
                                 referencedTableName="person" referencedColumnNames="person_id"/>
    </changeSet>

    <changeSet id="messages-22" author="Michał Lewandowski">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_patient_template"/>
        </preConditions>
        <comment>Update messages_template and messages_patient_template with improved query</comment>
        <sql>
            Update messages_template set service_query =
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, mssg_status as STATUS_ID from
            (select TIMESTAMP(selected_date, times) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS CHANNEL_ID
            from (select * from (select adddate(\'2019-12-01\',t4*10000 + t3*1000 + t2*100 + t1*10 + t0) selected_date
            from  (select 0 t0 union select 1 union select 2 union select 3 union select 4 union  select 5 union
            select 6 union select 7 union select 8 union select 9) t0,  (select 0 t1 union select 1 union
            select 2 union select 3 union select 4 union  select 5 union select 6 union select 7 union
            select 8 union select 9) t1,  (select 0 t2 union select 1 union select 2 union select 3 union
            select 4 union  select 5 union select 6 union select 7 union select 8 union select 9) t2,
            (select 0 t3 union select 1 union select 2 union select 3 union select 4 union  select 5 union
            select 6 union select 7 union select 8 union select 9) t3,  (select 0 t4 union select 1 union
            select 2 union select 3 union select 4 union  select 5 union select 6 union select 7 union
            select 8 union select 9) t4) v where selected_date between :Start_of_daily_messages and :End_of_daily_messages
            and :Week_day_of_delivering_message
            like concat(\'%\',DAYNAME(selected_date),\'%\')) dates JOIN (select :bestContactTime times) timeslist) temp
            LEFT JOIN (select mssg.msg_send_time as mssg_dates, mssg.status as mssg_status
            from messages_scheduled_service_group mssg where mssg.patient_id = :patientId) mss on mss.mssg_dates = EXECUTION_DATE
            where EXECUTION_DATE >= :startDate and EXECUTION_DATE &lt;= :endDate ;'
            where name = 'Adherence report daily';
        </sql>
        <sql>
            Update messages_patient_template set service_query = 'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, mssg_status as STATUS_ID from
            (select TIMESTAMP(selected_date, times) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS CHANNEL_ID
            from (select * from (select adddate(\'2019-12-01\',t4*10000 + t3*1000 + t2*100 + t1*10 + t0) selected_date
            from  (select 0 t0 union select 1 union select 2 union select 3 union select 4 union  select 5 union
            select 6 union select 7 union select 8 union select 9) t0,  (select 0 t1 union select 1 union
            select 2 union select 3 union select 4 union  select 5 union select 6 union select 7 union
            select 8 union select 9) t1,  (select 0 t2 union select 1 union select 2 union select 3 union
            select 4 union  select 5 union select 6 union select 7 union select 8 union select 9) t2,
            (select 0 t3 union select 1 union select 2 union select 3 union select 4 union  select 5 union
            select 6 union select 7 union select 8 union select 9) t3,  (select 0 t4 union select 1 union
            select 2 union select 3 union select 4 union  select 5 union select 6 union select 7 union
            select 8 union select 9) t4) v where selected_date between :Start_of_daily_messages and :End_of_daily_messages
            and :Week_day_of_delivering_message
            like concat(\'%\',DAYNAME(selected_date),\'%\')) dates JOIN (select :bestContactTime times) timeslist) temp
            LEFT JOIN (select mssg.msg_send_time as mssg_dates, mssg.status as mssg_status
            from messages_scheduled_service_group mssg where mssg.patient_id = :patientId) mss on mss.mssg_dates = EXECUTION_DATE
            where EXECUTION_DATE >= :startDate and EXECUTION_DATE &lt;= :endDate ;'
            where template_id = (select messages_template_id from messages_template where name = 'Adherence report daily') ;
        </sql>

    </changeSet>

    <changeSet id="messages-23" author="Michał Lewandowski">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_template_field"/>
        </preConditions>
        <comment>Added new inserts for templates and template fields</comment>
        <sql>
            INSERT INTO messages_template
            (service_query, service_query_type, name, creator, uuid, date_created)
            VALUES(
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, mssg_status as STATUS_ID, visitTypeId, locationId, dateStarted from
            (select TIMESTAMP(selected_date, :bestContactTime ) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS
            CHANNEL_ID, visitTypeId, locationId, visit_dates as dateStarted
            from (select * from (select adddate(\'2019-11-01\',t4*10000 + t3*1000 + t2*100 + t1*10 + t0) selected_date
            from (select 0 t0 union select 1 union select 2 union select 3 union select 4 union select 5 union
            select 6 union select 7 union select 8 union select 9) t0, (select 0 t1 union select 1 union
            select 2 union select 3 union select 4 union select 5 union select 6 union select 7 union
            select 8 union select 9) t1, (select 0 t2 union select 1 union select 2 union select 3 union
            select 4 union select 5 union select 6 union select 7 union select 8 union select 9) t2,
            (select 0 t3 union select 1 union select 2 union select 3 union select 4 union select 5 union
            select 6 union select 7 union select 8 union select 9) t3, (select 0 t4 union select 1 union
            select 2 union select 3 union select 4 union select 5 union select 6 union select 7 union
            select 8 union select 9) t4) dates_list
            where selected_date between :Start_of_messages and :End_of_messages) dates_in_range
            JOIN (Select date_started as visit_dates, visit_type_id as visitTypeId, location_id as locationId from visit where
            patient_id = :patientId ) dates_of_visit where (select property_value from global_property
            where property =\'message.daysToCallBeforeVisit.default\') like concat(\'%\',datediff(visit_dates, selected_date),\'%\')
            and date(visit_dates) !=  selected_date )dates_before_visit
            LEFT JOIN (select mssg.msg_send_time as mssg_dates, mssg.status as mssg_status from
            messages_scheduled_service_group mssg where mssg.patient_id = :patientId) mss on mss.mssg_dates = EXECUTION_DATE
            where EXECUTION_DATE >= :startDate and EXECUTION_DATE &lt;= :endDate ;',
            'SQL',
            'Visit reminder',
            1,
            '95573fe3-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'Service type',
            1,
            'Deactivate service',
            (select messages_template_id from messages_template where uuid = '95573fe3-20b2-11ea-ac12-0242c0a82002'),
            'SERVICE_TYPE',
            1,
            '95574976-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'Start of messages',
            0,
            ' ',
            (select messages_template_id from messages_template where uuid = '95573fe3-20b2-11ea-ac12-0242c0a82002'),
            'START_OF_MESSAGES',
            1,
            '95575327-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
        <sql>
            INSERT INTO messages_template_field
            (name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created)
            VALUES(
            'End of messages',
            1,
            '2020-01-30',
            (select messages_template_id from messages_template where uuid = '95573fe3-20b2-11ea-ac12-0242c0a82002'),
            'END_OF_MESSAGES',
            1,
            '95575cbd-20b2-11ea-ac12-0242c0a82002',
            now()
            );
        </sql>
    </changeSet>

    <changeSet id="messages-24" author="Oskar Hinc">
        <preConditions>
            <tableExists tableName="messages_scheduled_service"/>
            <foreignKeyConstraintExists foreignKeyName="messages_scheduled_service_channel_type_fk"/>
            <foreignKeyConstraintExists foreignKeyName="messages_scheduled_service_service_fk"/>
            <columnExists tableName="messages_scheduled_service" columnName="channel_type"/>
            <columnExists tableName="messages_scheduled_service" columnName="service"/>
        </preConditions>

        <comment>Changes type of few messages_scheduled_service columns from concept to string</comment>

        <dropForeignKeyConstraint constraintName="messages_scheduled_service_channel_type_fk"
                                  baseTableName="messages_scheduled_service" />
        <dropColumn tableName="messages_scheduled_service"
                    columnName="channel_type"/>

        <dropForeignKeyConstraint constraintName="messages_scheduled_service_service_fk"
                                  baseTableName="messages_scheduled_service" />
        <dropColumn tableName="messages_scheduled_service"
                    columnName="service"/>

        <addColumn tableName="messages_template">
            <column name="channel_type" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="service" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="messages-25" author="Oskar Hinc">
        <preConditions>
            <tableExists tableName="messages_template_field"/>
            <columnExists tableName="messages_template_field" columnName="default_value"/>
            <columnExists tableName="messages_template_field" columnName="template_field_type"/>
        </preConditions>

        <comment>Changed default values for start of messages fields to empty string</comment>

        <sql>
            UPDATE messages_template_field
            SET default_value=''
            WHERE template_field_type='START_OF_MESSAGES';
        </sql>

    </changeSet>

    <changeSet id="messages-26" author="Daniel Serkowski">
        <preConditions>
            <tableExists tableName="messages_scheduled_service"/>
            <tableExists tableName="messages_template"/>
            <not><columnExists tableName="messages_scheduled_service" columnName="channel_type"/></not>
            <not><columnExists tableName="messages_scheduled_service" columnName="service"/></not>
            <columnExists tableName="messages_template" columnName="channel_type"/>
            <columnExists tableName="messages_template" columnName="service"/>
        </preConditions>

        <comment>Fixed the issue with defining channel_type and service in messages_template instead in
            messages_scheduled_service (issue of the changeSet 'messages-24')</comment>

        <dropColumn tableName="messages_template" columnName="channel_type"/>
        <dropColumn tableName="messages_template" columnName="service"/>

        <addColumn tableName="messages_scheduled_service">
            <column name="channel_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="service" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="messages-27" author="Daniel Serkowski">
        <preConditions>
            <tableExists tableName="global_property"/>
        </preConditions>

        <comment>Resets messages.reschedulingStrategy to the default value (the property structure and its description
            have been changed). It is in order to apply the new changes to all already existing environments. The
            migration can be removed if the liquibase refactor will be conducted (eg. replacing all changes by one
            changeSet).</comment>

        <delete tableName="global_property">
            <where>property='messages.reschedulingStrategy'</where>
        </delete>
    </changeSet>

    <changeSet id="messages-28" author="Arkadiusz Lalo">
        <preConditions>
            <tableExists tableName="global_property"/>
        </preConditions>

        <comment>
            Resets message.consent.validation to the default value. It is in order to apply the new changes to all
            already existing environments. The migration can be removed if the liquibase refactor will be
            conducted (eg. replacing all changes by one changeSet).
        </comment>

        <delete tableName="global_property">
            <where>property='message.consent.validation'</where>
        </delete>
    </changeSet>

    <changeSet id="messages-29" author="Oskar Hinc">
        <preConditions>
            <tableExists tableName="global_property"/>
        </preConditions>

        <comment>
            Resets message.bestContactTime.default to the default value. It is in order to apply the new changes to all
            already existing environments. The migration can be removed if the liquibase refactor will be
            conducted (eg. replacing all changes by one changeSet).
        </comment>

        <delete tableName="global_property">
            <where>property='message.bestContactTime.default'</where>
        </delete>
    </changeSet>

    <changeSet id="messages-30" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type" />
            <sqlCheck expectedResult="1">
                select count(*) from person_attribute_type
                    where uuid = 'dda246c6-c806-402a-9b7c-e2c1574a6441' and name like 'Patient status'
            </sqlCheck>
        </preConditions>

        <comment>
            Change the name and description for the person status attribute. It is in order to apply the new changes to all
            already existing environments. The migration can be removed if the liquibase refactor will be
            conducted (eg. replacing all changes by one changeSet).
        </comment>

        <update tableName="person_attribute_type">
            <column name="name" value="Person status" />
            <column name="description" value="Person status attribute" />
            <where>uuid = 'dda246c6-c806-402a-9b7c-e2c1574a6441'</where>
        </update>
    </changeSet>

    <changeSet id="messages-31" author="Michał Lewandowski">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_template_field"/>
            <tableExists tableName="messages_scheduled_service"/>
        </preConditions>

        <comment>Added view for dates, function with if for query, update Query to adjust to edge cases</comment>

        <sql>
            DROP VIEW IF EXISTS DIGITS_0;
            CREATE VIEW DIGITS_0 as SELECT 0 t0 union select 1 union select 2 union select 3 union select 4
            union  select 5 union select 6 union select 7 union select 8 union select 9;

            DROP VIEW IF EXISTS DIGITS_1;
            CREATE VIEW DIGITS_1 as SELECT 0 t1 union select 1 union select 2 union select 3 union select 4
            union  select 5 union select 6 union select 7 union select 8 union select 9;

            DROP VIEW IF EXISTS DIGITS_2;
            CREATE VIEW DIGITS_2 as SELECT 0 t2 union select 1 union select 2 union select 3 union select 4
            union  select 5 union select 6 union select 7 union select 8 union select 9;

            DROP VIEW IF EXISTS DIGITS_3;
            CREATE VIEW DIGITS_3 as SELECT 0 t3 union select 1 union select 2 union select 3 union select 4
            union  select 5 union select 6 union select 7 union select 8 union select 9;

            DROP VIEW IF EXISTS DIGITS_4;
            CREATE VIEW DIGITS_4 as SELECT 0 t4 union select 1 union select 2 union select 3 union select 4
            union  select 5 union select 6 union select 7 union select 8 union select 9;

            DROP VIEW IF EXISTS DATES_LIST;
            CREATE VIEW DATES_LIST as select adddate(CURRENT_DATE(),t4*10000 + t3*1000 + t2*100 + t1*10 + t0) selected_date
            from  DIGITS_0 as t0, DIGITS_1 as t1, DIGITS_2 as t2, DIGITS_3 as t3, DIGITS_4 as t4;
        </sql>

        <sql>
            Update messages_template set service_query =
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, null as STATUS_ID from
            (select TIMESTAMP(selected_date, :bestContactTime) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS CHANNEL_ID
            from (select * from (select * from DATES_LIST) v where selected_date >= :Start_of_daily_messages and selected_date &lt;= :End_of_daily_messages
            and selected_date &lt; :endDate  and :Week_day_of_delivering_message
            like concat(\'%\',DAYNAME(selected_date),\'%\') and selected_date > GET_PREDICTION_START_DATE_FOR_ADHERENCE_DAILY(:patientId) ) dates ) temp
            where CHANNEL_ID != \'Deactivate service\'
            UNION
            Select mssg.msg_send_time as EXECUTION_DATE, 1 as MESSAGE_ID, mss.channel_type as CHANNEL_ID, mss.status as STATUS_ID from messages_scheduled_service mss
            join messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
            join messages_template mt on mt.messages_template_id = mpt.template_id
            join messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
            where mt.name = \'Adherence report daily\' and mpt.patient_id = :patientId and \'PENDING, DELIVERED, FAILED\' like concat(\'%\',mss.status,\'%\') and mssg.msg_send_time > :startDate
            order by 1 desc;'
            where name = 'Adherence report daily';
        </sql>

        <sql>
            Update messages_patient_template set service_query = ''
            where template_id = (select messages_template_id from messages_template where name = 'Adherence report daily') ;
        </sql>
        <sql>
            ALTER TABLE messages_scheduled_service
            ADD CHECK (status != 'FUTURE');
        </sql>

    </changeSet>
    <changeSet id="messages-32" author="Michał Lewandowski">
        <sql splitStatements="false" stripComments="false">
            <![CDATA[

                CREATE FUNCTION `GET_PREDICTION_START_DATE_FOR_ADHERENCE_DAILY`(patient_id long)
                RETURNS DATE
                BEGIN
                DECLARE mssg_date DATE;
                SET mssg_date =
                    (SELECT EXECUTION_DATE FROM
                        (SELECT
                            mssg.msg_send_time AS EXECUTION_DATE,
                            1 AS MESSAGE_ID,
                            mss.channel_type AS CHANNEL_ID,
                            mss.status AS STATUS_ID
                        FROM messages_scheduled_service mss
                            JOIN messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                            JOIN messages_template mt on mt.messages_template_id = mpt.template_id
                            JOIN messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
                        WHERE
                            mt.name = 'Adherence report daily'
                            AND mpt.patient_id = patient_id
                        ORDER BY 1 DESC)
                    a LIMIT 1);
                RETURN if(mssg_date > NOW(), mssg_date, NOW());
                END

            ]]>
        </sql>
    </changeSet>

    <changeSet id="messages-33" author="Michał Lewandowski">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_template_field"/>
            <tableExists tableName="messages_scheduled_service"/>
        </preConditions>

        <comment>Added view for dates, function with if for query, update Query to adjust to edge cases</comment>

        <sql>
            Update messages_template set service_query =
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, null as STATUS_ID, visitTypeId, locationId, dateStarted from
            (select TIMESTAMP(selected_date, :bestContactTime ) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS
            CHANNEL_ID, visitTypeId, locationId, visit_dates as dateStarted
            from (select * from (select * from DATES_LIST) dates_list
            where selected_date >= :Start_of_messages and selected_date &lt;= :End_of_messages) dates_in_range
            JOIN (Select date_started as visit_dates, visit_type_id as visitTypeId, location_id as locationId from visit
            where patient_id = :patientId ) dates_of_visit
            where (select property_value from global_property
            where property =\'message.daysToCallBeforeVisit.default\') like concat(\'%\',datediff(visit_dates, selected_date),\'%\')
            and date(visit_dates) !=  selected_date )dates_before_visit
            where EXECUTION_DATE &lt;= :endDate and EXECUTION_DATE >= GET_PREDICTION_START_DATE_FOR_VISIT(:patientId)
            and CHANNEL_ID != \'Deactivate service\'
            Union
            Select mssg.msg_send_time as EXECUTION_DATE, 1 as MESSAGE_ID, mss.channel_type as CHANNEL_ID,
            mss.status as STATUS_ID, null as visitTypeId, null as locationId, null as dateStarted
            from messages_scheduled_service mss
            join messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
            join messages_template mt on mt.messages_template_id = mpt.template_id
            join messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
            where mt.name = \'Visit reminder\' and mpt.patient_id = :patientId and mssg.msg_send_time > :startDate
            order by 1 desc;'
            where name = 'Visit reminder';
        </sql>

        <sql>
            Update messages_patient_template set service_query = ''
            where template_id = (select messages_template_id from messages_template where name = 'Visit reminder') ;
        </sql>
    </changeSet>

    <changeSet id="messages-34" author="Michał Lewandowski">
        <sql splitStatements="false" stripComments="false">
            <![CDATA[
                        CREATE FUNCTION `GET_PREDICTION_START_DATE_FOR_VISIT`(patient_id long)
                        RETURNS date
                        BEGIN
                        DECLARE mssg_date DATE;
                        SET mssg_date =
                            (SELECT EXECUTION_DATE FROM
                                (SELECT mssg.msg_send_time AS EXECUTION_DATE, 1 AS MESSAGE_ID,
                                    mss.channel_type AS CHANNEL_ID, mss.status AS STATUS_ID
                                FROM messages_scheduled_service mss
                                    JOIN messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                                    JOIN messages_template mt on mt.messages_template_id = mpt.template_id
                                    JOIN messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
                                WHERE
                                    mt.name = 'Visit reminder'
                                    AND mpt.patient_id = patient_id
                                ORDER BY 1 DESC)
                               a LIMIT 1);
                        RETURN if(mssg_date > NOW(), mssg_date, NOW());
                        END
                ]]>
        </sql>
    </changeSet>

    <changeSet id="messages-35" author="Michał Lewandowski">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_template_field"/>
            <tableExists tableName="messages_scheduled_service"/>
        </preConditions>

        <comment>Adjust date conditions</comment>

        <sql>
            Update messages_template set service_query =
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, null as STATUS_ID from
            (select TIMESTAMP(selected_date, :bestContactTime) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS CHANNEL_ID
            from (select * from (select * from DATES_LIST) v
            where selected_date >= :Start_of_daily_messages
                and selected_date &lt;= :End_of_daily_messages
                and selected_date &lt;= :endDate and selected_date >= :startDate
                and :Week_day_of_delivering_message
                    like concat(\'%\',DAYNAME(selected_date),\'%\') ) dates ) temp
            where EXECUTION_DATE > GET_PREDICTION_START_DATE_FOR_ADHERENCE_DAILY(:patientId)
                and CHANNEL_ID != \'Deactivate service\'
            UNION
            Select mssg.msg_send_time as EXECUTION_DATE, 1 as MESSAGE_ID, mss.channel_type as CHANNEL_ID, mss.status as STATUS_ID
            from messages_scheduled_service mss
                join messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                join messages_template mt on mt.messages_template_id = mpt.template_id
                join messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
            where mt.name = \'Adherence report daily\'
                and mpt.patient_id = :patientId
                and mssg.msg_send_time >= :startDate
                and mssg.msg_send_time &lt;= :endDate
            order by 1 desc;'
            where name = 'Adherence report daily';
        </sql>

        <sql>
            Update messages_template set service_query =
            'select EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, null as STATUS_ID, visitTypeId, locationId, dateStarted from
            (select TIMESTAMP(selected_date, :bestContactTime ) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS
            CHANNEL_ID, visitTypeId, locationId, visit_dates as dateStarted
            from (select * from (select * from DATES_LIST) dates_list
            where selected_date >= :Start_of_messages
                and selected_date &lt;= :End_of_messages
            ) dates_in_range
            JOIN (Select date_started as visit_dates, visit_type_id as visitTypeId, location_id as locationId from visit
            where patient_id = :patientId ) dates_of_visit
            where (select property_value from global_property
            where property =\'message.daysToCallBeforeVisit.default\') like concat(\'%\',datediff(visit_dates, selected_date),\'%\')
                and date(visit_dates) !=  selected_date )dates_before_visit
            where EXECUTION_DATE &lt;= :endDate and EXECUTION_DATE >= :startDate
                and EXECUTION_DATE >= GET_PREDICTION_START_DATE_FOR_VISIT(:patientId)
                and CHANNEL_ID != \'Deactivate service\'
            Union
            Select mssg.msg_send_time as EXECUTION_DATE, 1 as MESSAGE_ID, mss.channel_type as CHANNEL_ID,
            mss.status as STATUS_ID, null as visitTypeId, null as locationId, null as dateStarted
            from messages_scheduled_service mss
                join messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                join messages_template mt on mt.messages_template_id = mpt.template_id
                join messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
            where mt.name = \'Visit reminder\'
                and mpt.patient_id = :patientId
                and mssg.msg_send_time >= :startDate
                and mssg.msg_send_time &lt;= :endDate
            order by 1 desc;'
            where name = 'Visit reminder';
        </sql>
    </changeSet>

    <changeSet id="messages-36" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                select count(*) from global_property
                where property = 'message.personStatus.configuration'
            </sqlCheck>
        </preConditions>

        <comment>Resets message.personStatus.configuration to the default value (the property structure and its description
            have been changed). It is in order to apply the new changes to all already existing environments. The
            migration can be removed if the liquibase refactor will be conducted (eg. replacing all changes by one
            changeSet).</comment>

        <delete tableName="global_property">
            <where>property='message.personStatus.configuration'</where>
        </delete>
    </changeSet>
    <changeSet id="messages-37" author="Michał Lewandowski">
        <sql>
            DROP FUNCTION IF EXISTS GET_PREDICTION_START_DATE_FOR_VISIT;
        </sql>
        <sql splitStatements="false" stripComments="false">

            <![CDATA[
                        CREATE FUNCTION `GET_PREDICTION_START_DATE_FOR_VISIT`(patient_id long)
                        RETURNS DATETIME
                        BEGIN
                        DECLARE mssg_date DATE;
                        SET mssg_date =
                            (SELECT EXECUTION_DATE FROM
                                (SELECT mssg.msg_send_time AS EXECUTION_DATE, 1 AS MESSAGE_ID,
                                    mss.channel_type AS CHANNEL_ID, mss.status AS STATUS_ID
                                FROM messages_scheduled_service mss
                                    JOIN messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                                    JOIN messages_template mt on mt.messages_template_id = mpt.template_id
                                    JOIN messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
                                WHERE
                                    mt.name = 'Visit reminder'
                                    AND mpt.patient_id = patient_id
                                ORDER BY 1 DESC)
                               a LIMIT 1);
                        RETURN if(mssg_date > NOW(), mssg_date, NOW());
                        END
                ]]>
        </sql>
        <sql>
            DROP FUNCTION IF EXISTS GET_PREDICTION_START_DATE_FOR_ADHERENCE_DAILY;
        </sql>
        <sql splitStatements="false" stripComments="false">

            <![CDATA[
                CREATE FUNCTION `GET_PREDICTION_START_DATE_FOR_ADHERENCE_DAILY`(patient_id long)
                RETURNS DATETIME
                BEGIN
                DECLARE mssg_date DATE;
                SET mssg_date =
                    (SELECT EXECUTION_DATE FROM
                        (SELECT
                            mssg.msg_send_time AS EXECUTION_DATE,
                            1 AS MESSAGE_ID,
                            mss.channel_type AS CHANNEL_ID,
                            mss.status AS STATUS_ID
                        FROM messages_scheduled_service mss
                            JOIN messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                            JOIN messages_template mt on mt.messages_template_id = mpt.template_id
                            JOIN messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
                        WHERE
                            mt.name = 'Adherence report daily'
                            AND mpt.patient_id = patient_id
                        ORDER BY 1 DESC)
                    a LIMIT 1);
                RETURN if(mssg_date > NOW(), mssg_date, NOW());
                END

            ]]>
        </sql>
    </changeSet>
    <changeSet id="messages-38" author="Michał Lewandowski">
        <sql>
            Update messages_template_field set default_value = 'NO_DATE|EMPTY' where template_field_type = 'END_OF_MESSAGES';
        </sql>
    </changeSet>

    <changeSet id="messages-39" author="Artur Fijał">
        <preConditions>
            <not><tableExists tableName="messages_template_field_default_values"/></not>
        </preConditions>
        <comment>Created the template_field_default_values table</comment>
        <createTable tableName="messages_template_field_default_values">
            <column name="messages_template_field_default_values_id" type="int" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="relationship_type" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="relationship_direction" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="template_field" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="default_value" type="TEXT"/>
            <column name="creator" type="int"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
        </createTable>
        <addForeignKeyConstraint constraintName="messages_template_field_default_values_relationship_type_fk"
                                 baseTableName="messages_template_field_default_values" baseColumnNames="relationship_type"
                                 referencedTableName="relationship_type" referencedColumnNames="relationship_type_id"/>
        <addForeignKeyConstraint constraintName="messages_template_field_default_values_template_field_fk"
                                 baseTableName="messages_template_field_default_values" baseColumnNames="template_field"
                                 referencedTableName="messages_template_field" referencedColumnNames="messages_template_field_id"/>
    </changeSet>

    <changeSet id="messages-40" author="Michał Lewandowski">
        <preConditions>
            <tableExists tableName="messages_template"/>
            <tableExists tableName="messages_template_field"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM messages_template
                WHERE uuid = '96d93c15-3884-11ea-b1e9-0242ac160002'
            </sqlCheck>
        </preConditions>

        <comment>Added new inserts for templates and template fields</comment>

        <sql>
            INSERT INTO messages_template
            (
                service_query, service_query_type, name, creator, uuid, date_created
            )
            VALUES(
                'SELECT EXECUTION_DATE, MESSAGE_ID, CHANNEL_ID, null as STATUS_ID FROM
                (SELECT TIMESTAMP(selected_date, :bestContactTime) AS EXECUTION_DATE, 1 AS MESSAGE_ID, :Service_type AS CHANNEL_ID
                FROM (SELECT * FROM (SELECT * FROM DATES_LIST) v
                WHERE selected_date >= :Start_of_weekly_messages
                AND selected_date &lt;= :End_of_weekly_messages
                AND selected_date &lt;= :endDate
                AND selected_date >= :startDate
                AND :Week_day_of_delivering_message
                like concat(\'%\',DAYNAME(selected_date),\'%\') ) dates ) temp
                WHERE EXECUTION_DATE > GET_PREDICTION_START_DATE_FOR_ADHERENCE_WEEKLY(:patientId)
                AND CHANNEL_ID != \'Deactivate service\'
                UNION
                SELECT mssg.msg_send_time as EXECUTION_DATE, 1 as MESSAGE_ID, mss.channel_type as CHANNEL_ID, mss.status as STATUS_ID
                FROM messages_scheduled_service mss
                JOIN messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                JOIN messages_template mt on mt.messages_template_id = mpt.template_id
                JOIN messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
                WHERE mt.name = \'Adherence report weekly\'
                AND mpt.patient_id = :patientId
                AND mssg.msg_send_time >= :startDate
                AND mssg.msg_send_time &lt;= :endDate
                ORDER BY 1 DESC;',
                'SQL',
                'Adherence report weekly',
                1,
                '96d93c15-3884-11ea-b1e9-0242ac160002',
                now()
            );
        </sql>

        <sql>
            INSERT INTO messages_template_field
            (
                name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created
            )
            VALUES(
                'Service type',
                1,
                'Deactivate service',
                (SELECT messages_template_id FROM messages_template WHERE uuid = '96d93c15-3884-11ea-b1e9-0242ac160002'
                ),
                'SERVICE_TYPE',
                1,
                'ce1ae5a2-3884-11ea-b1e9-0242ac160002',
                now()
            );
        </sql>

        <sql>
            INSERT INTO messages_template_field
            (
                name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created
            )
            VALUES(
                'Week day of delivering message',
                1,
                'Monday',
                (SELECT messages_template_id FROM messages_template WHERE uuid = '96d93c15-3884-11ea-b1e9-0242ac160002'),
                'DAY_OF_WEEK_SINGLE',
                1,
                'dce23c53-3884-11ea-b1e9-0242ac160002',
                now()
            );
        </sql>

        <sql>
            INSERT INTO messages_template_field
            (
                name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created
            )
            VALUES(
                'Start of weekly messages',
                0,
                '',
                (SELECT messages_template_id FROM messages_template WHERE uuid = '96d93c15-3884-11ea-b1e9-0242ac160002'),
                'START_OF_MESSAGES',
                1,
                'fc9cf90e-3884-11ea-b1e9-0242ac160002',
                now()
            );
        </sql>

        <sql>
            INSERT INTO messages_template_field
            (
                name, mandatory, default_value, template_id, template_field_type, creator, uuid, date_created
            )
            VALUES(
                'End of weekly messages',
                1,
                'NO_DATE|EMPTY',
                (SELECT messages_template_id FROM messages_template WHERE uuid = '96d93c15-3884-11ea-b1e9-0242ac160002'),
                'END_OF_MESSAGES',
                1,
                'f0f4750c-3884-11ea-b1e9-0242ac160002',
                now()
            );
        </sql>

        <sql splitStatements="false" stripComments="false">
            <![CDATA[
                CREATE FUNCTION `GET_PREDICTION_START_DATE_FOR_ADHERENCE_WEEKLY`(patient_id long)
                RETURNS DATETIME
                BEGIN
                DECLARE mssg_date DATE;
                SET mssg_date =
                    (SELECT EXECUTION_DATE FROM
                        (SELECT mssg.msg_send_time AS EXECUTION_DATE, 1 AS MESSAGE_ID,
                            mss.channel_type AS CHANNEL_ID, mss.status AS STATUS_ID
                        FROM messages_scheduled_service mss
                            JOIN messages_patient_template mpt on mpt.messages_patient_template_id = mss.patient_template_id
                            JOIN messages_template mt on mt.messages_template_id = mpt.template_id
                            JOIN messages_scheduled_service_group mssg on mssg.messages_scheduled_service_group_id = mss.group_id
                        WHERE
                            mt.name = 'Adherence report weekly'
                            AND mpt.patient_id = patient_id
                        ORDER BY 1 DESC)
                       a LIMIT 1);
                RETURN if(mssg_date > NOW(), mssg_date, NOW());
                END
            ]]>
        </sql>
    </changeSet>

    <changeSet id="messages-41" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                select count(*) from global_property
                where property = 'message.personStatus.configuration'
            </sqlCheck>
        </preConditions>

        <comment>Resets message.personStatus.configuration to the default value (the property structure and its description
            have been changed). It is in order to apply the new changes to all already existing environments. The
            migration can be removed if the liquibase refactor will be conducted (eg. replacing all changes by one
            changeSet).</comment>

        <delete tableName="global_property">
            <where>property='message.personStatus.configuration'</where>
        </delete>
    </changeSet>
</databaseChangeLog>
